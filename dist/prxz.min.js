!function(){"use strict";const e={fval(e,t=2,o=!0){if(null==e||""===e)return"-";const n=+e;return isNaN(n)?e+"":o?n.toLocaleString("ru-RU",{minimumFractionDigits:t,maximumFractionDigits:t}):n.toFixed(t)},fperc(e,t=2){if(null==e)return"-";const o=+e;return isNaN(o)?e+"":o.toFixed(t)+"%"},fmoney(e,t="RUB",o=2){if(null==e||""===e)return"-";const n=+e;return isNaN(n)?e+"":n.toLocaleString("ru-RU",{style:"currency",currency:t,minimumFractionDigits:o,maximumFractionDigits:o})},fshortval(e,t=2){if(null==e||""===e)return"-";const o=+e;if(isNaN(o))return e+"";const n=Math.abs(o);return n>=1e12?(o/1e12).toFixed(t)+" трлн":n>=1e9?(o/1e9).toFixed(t)+" млрд":n>=1e6?(o/1e6).toFixed(t)+" млн":n>=1e3?(o/1e3).toFixed(t)+" тыс":o.toFixed(t)}},t={formatDate(e,t="dd.mm.yyyy"){const{date:o,isValid:n}=this._parseDate(e);if(!n)return this._getFallbackValue(e);const s=this._convertToMoscowTime(o);return this._applyFormat(s,t)},_parseDate(e){if(!e)return{date:null,isValid:!1};const t=e instanceof Date?e:new Date(e),o=!isNaN(t.getTime());return{date:t,isValid:o}},_convertToMoscowTime:e=>new Date(e.getTime()+108e5),_getFallbackValue:e=>e?"Неверная дата":"-",_getLocalizedStrings:()=>({months:{short:["янв","фев","мар","апр","май","июн","июл","авг","сен","окт","ноя","дек"],full:["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"]},days:{short:["вс","пн","вт","ср","чт","пт","сб"],full:["воскресенье","понедельник","вторник","среда","четверг","пятница","суббота"]},ampm:{am:"AM",pm:"PM"}}),_applyFormat(e,t){const o=this._getLocalizedStrings(),n=e.getUTCDate(),s=e.getUTCMonth(),a=e.getUTCFullYear(),r=e.getUTCDay(),i=e.getUTCHours(),l=e.getUTCMinutes(),d=e.getUTCSeconds(),c=i>=12,u=i%12||12,m={d:n.toString(),dd:n.toString().padStart(2,"0"),ddd:o.days.short[r],dddd:o.days.full[r],m:""+(s+1),mm:(""+(s+1)).padStart(2,"0"),mmm:o.months.short[s],mmmm:o.months.full[s],yy:a.toString().slice(-2),yyyy:a.toString(),H:i.toString(),HH:i.toString().padStart(2,"0"),h:u.toString(),hh:u.toString().padStart(2,"0"),M:l.toString(),MM:l.toString().padStart(2,"0"),S:d.toString(),SS:d.toString().padStart(2,"0"),t:c?"p":"a",tt:c?o.ampm.pm:o.ampm.am,"\\{date\\}":`${n.toString().padStart(2,"0")}.${(""+(s+1)).padStart(2,"0")}.${a}`,"\\{time\\}":`${i.toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}`,"\\{time:s\\}":`${i.toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}:${d.toString().padStart(2,"0")}`};let p=t;(p.includes("{date}")||p.includes("{time}"))&&(p=p.replace("{date}",m["\\{date\\}"]).replace("{time:s}",m["\\{time:s\\}"]).replace("{time}",m["\\{time\\}"]));return p.replace(/d{1,4}|m{1,4}|y{2,4}|H{1,2}|h{1,2}|M{1,2}|S{1,2}|t{1,2}|\\[dmyt]/g,e=>e.startsWith("\\")?e.slice(1):m[e]||e)}},o={API_REQUEST:"background: #0057ff; color: white; padding: 2px 6px; border-radius: 3px",API_REQUEST_TEXT:"color: #0057ff",SUCCESS:"background: #4caf50; color: white; padding: 2px 6px; border-radius: 3px",SUCCESS_TEXT:"color: #4caf50",ERROR:"background: #f44336; color: white; padding: 2px 6px; border-radius: 3px",ERROR_TEXT:"color: #f44336",WARNING:"background: #ff9800; color: white; padding: 2px 6px; border-radius: 3px",WARNING_TEXT:"color: #ff9800",INFO:"background: #2196f3; color: white; padding: 2px 6px; border-radius: 3px",INFO_TEXT:"color: #2196f3",getStyleForStatus:e=>{switch(e.toLowerCase()){case"success":return{badge:o.SUCCESS,text:o.SUCCESS_TEXT};case"error":return{badge:o.ERROR,text:o.ERROR_TEXT};case"warning":return{badge:o.WARNING,text:o.WARNING_TEXT};case"info":default:return{badge:o.INFO,text:o.INFO_TEXT};case"debug":return{badge:"background: #9c27b0; color: white; padding: 2px 6px; border-radius: 3px",text:"color: #9c27b0"}}}};function n(e){try{const t=sessionStorage.getItem(e);return t?JSON.parse(t).access_token:null}catch(e){return console.log("Ошибка при получении токена:",e),null}}function s(e,t){return e.map(e=>{const o=t.filter(t=>t.dataset?.datasetId===e.id);return{scheduler:e,dashboards:o,dashboardCount:o.length}})}async function a(e,t){const o=[];for(let n=0;n<t.length;n++){const s=t[n];try{if(!s.isEnabled){o.push({...s,name:null,modifiedTime:null,modifiedBy:null});continue}n>0&&await new Promise(e=>setTimeout(e,20));const t=await fetch(`${moreInfoLink}${s.id}/model`,{method:"GET",headers:{Authorization:"Bearer "+e,"Content-Type":"application/json"}});if(t.ok){const e=await t.json();o.push({...s,name:e.name||null,modifiedTime:e.modifiedTime||null,modifiedBy:e.modifiedBy||null})}else console.warn("Не удалось получить дополнительную информацию для шедулера "+s.id),o.push({...s,name:null,modifiedTime:null,modifiedBy:null})}catch(e){console.error(`Ошибка при получении информации для шедулера ${s.id}:`,e),o.push({...s,name:null,modifiedTime:null,modifiedBy:null})}}return o}function n(e){try{const t=sessionStorage.getItem(e);return t?JSON.parse(t).access_token:null}catch(e){return console.log("Ошибка при получении токена:",e),null}}async function a(e,t){const o=[];for(let n=0;n<t.length;n++){const s=t[n];try{if(!s.isEnabled){o.push({...s,name:null,modifiedTime:null,modifiedBy:null});continue}n>0&&await new Promise(e=>setTimeout(e,20));const t=await fetch(`${moreInfoLink}${s.id}/model`,{method:"GET",headers:{Authorization:"Bearer "+e,"Content-Type":"application/json"}});if(t.ok){const e=await t.json();o.push({...s,name:e.name||null,modifiedTime:e.modifiedTime||null,modifiedBy:e.modifiedBy||null})}else console.warn("Не удалось получить дополнительную информацию для шедулера "+s.id),o.push({...s,name:null,modifiedTime:null,modifiedBy:null})}catch(e){console.error(`Ошибка при получении информации для шедулера ${s.id}:`,e),o.push({...s,name:null,modifiedTime:null,modifiedBy:null})}}return o}function s(e,t){return e.map(e=>{const o=t.filter(t=>t.dataset?.datasetId===e.id);return{scheduler:e,dashboards:o,dashboardCount:o.length}})}const r={final:{getMetricsMono:async function(){const e=function(){let e=window.location.href,t=new URL(e).hostname,o=e.split("&").find(e=>e.includes("workspaceId="));return o?(o=o.split("=")[1],console.log("Найден workspaceId:",o)):console.log("workspaceId не найден"),{shedulersLink:"https://"+t+"/data-management-service/api/v1/workspaces/"+o+"/scheduled-refresh/GetAll",dashesLink:"https://"+t+"/dashboard-service/api/workspaces/"+o+"/dashboards",moreInfoLink:"https://"+t+"/formula-engine/api/v1/workspaces/"+o+"/datasets/",workspaceAllLink:"https://"+t+"/workspace-service/api/v1/evaluate-workspaces-with-role",keyPath:"oidc.user:https://"+t+"/keycloak/realms/Visiology:visiology_designer"}}(),{shedulersLink:t,dashesLink:o,moreInfoLink:r,keyPath:i}=e,l=n(i),[d,c,u]=await Promise.all([fetch(t,{method:"GET",headers:{Authorization:"Bearer "+l,"Content-Type":"application/json"}}).then(e=>{if(!e.ok)throw Error(`HTTP error! status: ${e.status}, name: responseShedulers`);return e}),fetch(o,{method:"GET",headers:{Authorization:"Bearer "+l,"Content-Type":"application/json"}}).then(e=>{if(!e.ok)throw Error(`HTTP error! status: ${e.status}, name: responseDashboards`);return e})]),[m,p]=await Promise.all([d.json(),c.json(),u?u.json():Promise.resolve(null)]),g=await a(l,m),h=s(g,p),f=function(e,t){return{deadSchedulers:e.filter(e=>!0===e.isEnabled&&!t.some(t=>t.dataset?.datasetId===e.id))}}(g,p);return{dataShedulers:g,dataDashboards:p,dataAll:h,deadSchedulers:f}}},methods:{getAccessToken:n,getShedulersMore:a,groupDatasets:s}},i={version:"1.0.0",api:{visi:r},lg:{async api(e,t="GET",n=null,s={}){const a=(new Date).toISOString(),r="req_"+Math.random().toString(36).substr(2,9);return console.groupCollapsed(`%cAPI ${t}%c ${e}`,o.API_REQUEST,o.API_REQUEST_TEXT),console.log("Request ID:",r),console.log("Timestamp:",a),console.log("Method:",t),console.log("URL:",e),n&&Object.keys(n).length>0&&console.log("Request Data:",n),s.headers&&console.log("Headers:",s.headers),console.groupEnd(),fetch(e,{method:t,body:n?JSON.stringify(n):void 0,headers:{"Content-Type":"application/json",...s.headers},...s}).then(async n=>{const s=n.headers.get("content-type")?.includes("application/json"),i=s?await n.json():await n.text(),l=n.ok?"SUCCESS":"ERROR",d=o.getStyleForStatus(l);if(console.groupCollapsed(`%cAPI ${l}%c ${e}`,d.badge,d.text),console.log("Response ID:",r),console.log("Status:",`${n.status} ${n.statusText}`),console.log("Response Time:",Date.now()-new Date(a).getTime()+"ms"),console.log("Response Type:",s?"JSON":"TEXT"),s&&i?console.log("Response Data:",i):i&&console.log("Response Text:",i),console.groupEnd(),!n.ok)throw{status:n.status,statusText:n.statusText,data:i,url:e,method:t,requestId:r};return{data:i,status:n.status,headers:n.headers,requestId:r}}).catch(t=>{const n=o.getStyleForStatus("ERROR");throw console.groupCollapsed("%cAPI ERROR%c "+e,n.badge,n.text),console.log("Response ID:",r),console.log("Status:",t.status||"NETWORK_ERROR"),console.log("Total Time:",Date.now()-new Date(a).getTime()+"ms"),console.log("Error Details:",t),t.data&&console.log("Error Data:",t.data),console.groupEnd(),{...t,requestId:r,timestamp:a}})},log:{success(e,...t){const n=o.getStyleForStatus("SUCCESS");console.log("%cSUCCESS%c "+e,n.badge,n.text,...t)},error(e,...t){const n=o.getStyleForStatus("ERROR");console.log("%cERROR%c "+e,n.badge,n.text,...t)},info(e,...t){const n=o.getStyleForStatus("INFO");console.log("%cINFO%c "+e,n.badge,n.text,...t)},warn(e,...t){const n=o.getStyleForStatus("WARNING");console.log("%cWARNING%c "+e,n.badge,n.text,...t)},debug(e,...t){const n=o.getStyleForStatus("DEBUG");console.log("%cDEBUG%c "+e,n.badge,n.text,...t)}}},frm:{v:e,d:t}};"undefined"!=typeof window?window.prxz=i:"undefined"!=typeof global?global.prxz=i:"undefined"!=typeof self&&(self.prxz=i),"undefined"!=typeof module&&module.exports&&(module.exports=i),"function"==typeof define&&define.amd&&define([],function(){return i})}();